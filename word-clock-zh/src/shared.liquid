{% assign timestamp_utc = trmnl.system.timestamp_utc %}
{% assign user_timestamp = timestamp_utc | plus: trmnl.user.utc_offset %}
{% assign hour = user_timestamp | date: "%H" %} 
{% assign minute = user_timestamp | date: "%M" %}
{% assign cycle = trmnl.plugin_settings.custom_fields_values.cycle %}
{% assign script = trmnl.plugin_settings.custom_fields_values.script %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&display=swap');

  @font-face {
      font-family: 'Unifont';
      src: url('https://konard.github.io/twittermatrix/unifont.woff') format('woff'), url('https://konard.github.io/twittermatrix/unifont.ttf') format('truetype');
  }
  .wc_clock {
    container-type: size;
    font-weight: bold;
    grid-template-columns: repeat(6, auto);
    align-content: space-around;
    justify-content: space-around;
    > span {
      font-family: 'Noto Sans SC', sans-serif;
      font-size: min(15cqb, 12cqi);
      display: block;
      width: max-content;
      line-height: 1;
    }
    .view--half_horizontal & {
      grid-template-columns: repeat(10, auto);
      > span {
        font-size: min(23cqb, 8cqi);
      }
    }
  } 
  .wc_highlighted {
    color: #000;
  }
  .screen--1bit, .screen--2bit {
    .title_bar .title, .title_bar .instance {
      --title-bar-font-family: Unifont, sans-serif;
      --title-bar-padding-top: 0;
    }
  }
</style>
<div class="layout layout--col layout--center-y" data-hour="{{ hour }}" data-minute="{{ minute }}" data-cycle="{{ cycle }}">
  <div class="gap--none grid w-full h-full text--gray-7 wc_clock" lang="zh-{{ script }}">
    <span>上</span><span>中</span><span>下</span><span>午</span><span>二</span><span>十</span>
    <span>一</span><span>二</span><span>{% if script == "Hans" %}两{% else %}兩{% endif %}</span><span>三</span><span>四</span><span>五</span>
    <span>六</span><span>七</span><span>八</span><span>九</span><span>零</span><span>{% if script == "Hans" %}点{% else %}點{% endif %}</span>
    <span>{% if script == "Hans" %}过{% else %}過{% endif %}</span><span>差</span><span>半</span><span>一</span><span>二</span><span>三</span>
    <span>四</span><span>十</span><span>刻</span><span>五</span><span>分</span><span>整</span>
  </div>
</div>
<div class="title_bar word-clock-zh">
  <img class="image" src="https://trmnl.com/images/plugins/trmnl--render.svg" />
  <span class="title" lang="zh-{{ script }}">{% if script == "Hans" %}文字时钟{% else %}文字時鐘{% endif %}</span>
  <span class="instance">{{trmnl.user.time_zone}}</span>
</div>

<script>
  (() => {
    const hour = parseInt(document.querySelector('.layout').dataset.hour);
    const minute = parseInt(document.querySelector('.layout').dataset.minute);
    const cycle = document.querySelector('.layout').dataset.cycle;
    const wordNodes = document.querySelectorAll('.wc_clock span');

    // Snap minute to nearest 5 (floor)
    const snappedMinute = Math.floor(minute / 5) * 5;
    
    // Formatted minutes mapping (0-55 in steps of 5)
    const minuteFormats = [
      '整',      // 0
      '{% if script == "Hans" %}过{% else %}過{% endif %}五分',  // 5
      '十分',    // 10
      '一刻',    // 15
      '二十',    // 20
      '二十五',  // 25
      '半',      // 30
      '三十五',  // 35
      '四十',    // 40
      '三刻',    // 45
      '五十',    // 50
      '差五分'   // 55
    ];
    
    // Hour formatting (0-23)
    const hourFormats = [
      '零', '一', '{% if script == "Hans" %}两{% else %}兩{% endif %}', '三', '四', '五', '六', '七', '八', '九', '十',
      '十一', '十二', '十三', '十四', '十五', '十六', '十七', '十八', '十九',
      '二十', '二十一', '二十二', '二十三'
    ];
    
    // Period prefixes for h12 cycle
    const getPeriod = (h) => {
      if (h >= 0 && h <= 10) return '上午';
      if (h >= 11 && h <= 13) return '中午';
      return '下午';
    };
    
    // Calculate display hour (advance if minute is 55)
    let displayHour = hour;
    if (snappedMinute === 55) {
      displayHour = (hour + 1) % 24;
    }
    
    // Format the hour part
    let formattedHour;
    if (cycle === 'h12') {
      const period = getPeriod(displayHour);
      const h12 = displayHour % 12 || 12;
      formattedHour = period + hourFormats[h12];
    } else {
      formattedHour = hourFormats[displayHour];
    }
    
    // Format the minute part
    const minuteIndex = snappedMinute / 5;
    const formattedMinute = minuteFormats[minuteIndex];
    
    // Build full time string
    const timeString = formattedHour + '{% if script == "Hans" %}点{% else %}點{% endif %}' + formattedMinute;
    
    // Greedily match nodes
    const nodeTexts = Array.from(wordNodes).map(n => n.textContent);
    let searchIndex = 0;
    
    for (let i = 0; i < timeString.length; i++) {
      const char = timeString[i];
      // Find next matching node starting from searchIndex
      for (let j = searchIndex; j < nodeTexts.length; j++) {
        if (nodeTexts[j] === char) {
          wordNodes[j].classList.add('wc_highlighted');
          searchIndex = j + 1;
          break;
        }
      }
    }

    function getLocalizedTimeZoneName(tzdataId = {{ trmnl.user.time_zone_iana | json }}, locale = 'zh-{{ script }}') {
      // Create a new Date object. The specific date doesn't matter for getting the timezone name,
      // but a date is required for the Intl.DateTimeFormat constructor.
      const date = new Date(); 
    
      // Create an Intl.DateTimeFormat instance with the desired locale and timezone options.
      const formatter = new Intl.DateTimeFormat(locale, {
        timeZone: tzdataId,
        timeZoneName: 'long', // 'long' for full name (e.g., "Pacific Standard Time"), 'short' for abbreviation (e.g., "PST")
      });
    
      // Format the date to get the localized timezone name.
      // The output will be a string like "Tuesday, December 3, 2025 at 6:03:00 PM Pacific Standard Time".
      // We need to extract only the timezone name part.
      const formattedString = formatter.format(date);
    
      // Extract the timezone name from the formatted string.
      // This approach assumes the timezone name is typically at the end of the formatted string.
      // For more robust extraction, you might consider using formatToParts().
      const parts = formatter.formatToParts(date);
      const timeZoneNamePart = parts.find(part => part.type === 'timeZoneName');
    
      return timeZoneNamePart ? timeZoneNamePart.value : {{ trmnl.user.time_zone | json }};
    }
    
    document.querySelector('.word-clock-zh .instance').innerText = getLocalizedTimeZoneName();
  })();
</script>