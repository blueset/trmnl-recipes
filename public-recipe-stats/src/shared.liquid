{% template row %}
<div class="item {{ item_class }}" data-connections="{{ data.stats.installs | plus: data.stats.forks }}" data-installs="{{ data.stats.installs }}" data-forks="{{ data.stats.forks }}">
  <span class="meta {{ meta_label_class }}"><span class="index">{{ idx }}</span></span>
  <img class="binarize {{ screenshot_class | default: "hidden" }}" src="{{ data.screenshot_url | default: "https://usetrmnl.com/images/plugins/trmnl--render.svg" }}" />
  <div class="binarize {{ item_box_class | default: "flex flex--left flex--row content grow" }}">
    <img class="image w--auto no-shrink {{ icon_class }}" src="{{ data.icon_url | default: "https://usetrmnl.com/images/plugins/trmnl--render.svg" }}" onerror="handleImageError(this)" data-content-type="{{ data.icon_content_type }}" />
    <div class="{{ meta_box_class | default: "flex flex--col flex--left gap--none w--0 w--max-full grow" }}">
      <span class="{{ title_class }} truncate-text w--max-full">{{ data.name }}</span>
      <div class="flex flex--row flex--left {{ meta_row_class }}">
        <span class="{{ value_class }}" data-t="total">&lcub;{{ data.stats.installs | plus: data.stats.forks }} :number &rcub;</span>
        <span class="hidden {{ value_class }}">{{ data.stats.installs | plus: data.stats.forks }}</span>
        <div class="{{ meta_class }}">
          <span class="description" data-t="installs" data-t-value="{{ data.stats.installs }}">{% raw %}.input {$value :number} .match $value zero {{No install}} one {{{$value} install}} * {{{$value} installs}}{% endraw %}</span>
          <span class="description" data-t="forks" data-t-value="{{ data.stats.forks }}">{% raw %}.input {$value :number} .match $value zero {{No fork}} one {{{$value} fork}} * {{{$value} forks}} {% endraw %}</span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endtemplate %}

{% template plugin %}
<div style="display: contents;" lang="{{ trmnl.user.locale | escape }}" data-t-data="{{ 'public_recipe_stats' | l_word: trmnl.user.locale | json | escape }}">
{% liquid 
    assign total_installs = 0
    assign total_forks = 0
    for item in json_data
        assign total_installs = total_installs | plus: item.stats.installs
        assign total_forks = total_forks | plus: item.stats.forks
    endfor
    assign total_connections = total_installs | plus: total_forks
%}
<svg width="0" height="0" style="position: absolute;">
  <defs>
    <filter id="binarize" color-interpolation-filters="linearRGB" filterUnits="objectBoundingBox" primitiveUnits="userSpaceOnUse">
    <!-- Convert to grayscale -->
    <feColorMatrix type="matrix"
      values="0.0722 0.7152 0.2126 0 0
              0.0722 0.7152 0.2126 0 0
              0.0722 0.7152 0.2126 0 0
              0      0      0      1 0"/>
    <!-- Threshold: everything above 0.5 becomes white, below becomes black -->
    <feComponentTransfer>
      <feFuncR type="discrete" tableValues="0 0.25 0.75 1"/>
      <feFuncG type="discrete" tableValues="0 0.25 0.75 1"/>
      <feFuncB type="discrete" tableValues="0 0.25 0.75 1"/>
    </feComponentTransfer>
  </filter>
  </defs>
</svg>
<div class="gap--large layout layout--col">
  {% assign data_size = json_data | size %}
  {% if data_size > 0 %}
    <div class="columns" {% if overflow_cols %}data-overflow-max-cols="{{ overflow_cols }}"{% endif %} {% if overflow_counter and to < total %}data-overflow-counter="true"{% endif %}>
      <div class="column">
        {% for item in json_data %}
        {% render "row", idx: forloop.index, data: item, 
           item_class: item_class, title_class: title_class, value_class: value_class, 
           icon_class: icon_class, meta_class: meta_class, 
           meta_label_class: meta_label_class, screenshot_class: screenshot_class,
           item_box_class: item_box_class, meta_box_class: meta_box_class,
           meta_row_class: meta_row_class 
        %}
        {% endfor %}
        {% if overflow_counter and data_size < total %}
        <div class="item" data-alt-overflow-label="true"><div class="meta"></div><div class="content"><span class="label label--gray" data-t="and_more" data-t-value="{{ total | minus: data_size }}">and {$value} more</span></div></div>
        {% endif %}
        {% if overflow_counter and trmnl.plugin_settings.custom_fields_values.selection == "recipe_ids" %}
        {% assign total = trmnl.plugin_settings.custom_fields_values.recipe_ids | split: "," | size %}
        <div class="item" data-alt-overflow-label="true"><div class="meta"></div><div class="content"><span class="label label--gray" data-t="and_more" data-t-value="{{ total | minus: data_size }}">and {$value} more</span></div></div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="richtext gap">
      {% if trmnl.plugin_settings.custom_fields_values.selection == "keyword" and trmnl.plugin_settings.custom_fields_values.keyword != "" %}
      <div class="text--center content--large content" data-t="error_keyword_title" data-t-keyword="{{ trmnl.plugin_settings.custom_fields_values.keyword }}">“{$keyword}” did not match any result.</div>
      <div class="text--center content" data-t="error_keyword_subtitle">Try searching for something else.</div>
      {% elsif trmnl.plugin_settings.custom_fields_values.selection == "keyword" and trmnl.plugin_settings.custom_fields_values.keyword == "" %}
      <div class="text--center content--large content" data-t="error_new_title">No new recipe is found.</div>
      <div class="text--center content" data-t="error_new_subtitle">This shouldn’t happen.</div>
      {% elsif trmnl.plugin_settings.custom_fields_values.selection == "author_id" and trmnl.plugin_settings.custom_fields_values.author_id == "" %}
      <div class="text--center content--large content" data-t="error_self_title">You did not publish any recipe.</div>
      <div class="content" data-t="error_self_subtitle">Learn how to publish your first one at https://help.usetrmnl.com/en/articles/9510536-private-plugins</div>
      {% elsif trmnl.plugin_settings.custom_fields_values.selection == "author_id" and trmnl.plugin_settings.custom_fields_values.author_id != "" %}
      <div class="text--center content--large content" data-t="error_author_id_title" data-t-author="{{ author_id }}">User #{$authorId} did not publish any recipe.</div>
      <div class="content" data-t="error_author_id_subtitle">No recipe is found associated with this ID.</div>
      {% elsif trmnl.plugin_settings.custom_fields_values.selection == "recipe_ids" and trmnl.plugin_settings.custom_fields_values.recipe_ids == "" %}
      <div class="text--center content--large content" data-t="error_recipe_ids_title">No recipe ID is found.</div>
      <div class="content" data-t="error_recipe_ids_subtitle">Add a recipe ID to get started.</div>
      {% elsif trmnl.plugin_settings.custom_fields_values.selection == "recipe_ids" and trmnl.plugin_settings.custom_fields_values.recipe_ids != "" %}
      <div class="text--center content--large content" data-t="error_recipe_ids_title">No recipe ID is found valid.</div>
      <div class="content" data-t="error_recipe_ids_subtitle" data-t-ids="{{ trmnl.plugin_settings.custom_fields_values.recipe_ids }}">None of the recipe IDs {$ids} are valid, please verify your settings.</div>
      {% endif %}
    </div>
  {% endif %}
</div>
{% if total_connections > 0 and show_progress %}
<div class="p--0 title_bar pbar-title" style="position: relative">
  <span class="inline-flex bg--gray-30 rounded h--full t--0 l--0 installs-progress-bar" style="position: absolute; width: {{ total_installs | times: 100.0 | divided_by: total_connections }}%"> </span>
  <div class="flex flex--between flex--row px--2 w--full" style="z-index: 1; position: relative">
    {% if show_progress == "compact" %}
    <span class="pt--1 text-stroke label label-connections" data-t="connectionsShort">+&lcub;{{ total_connections }} :number &rcub;</span>
    <span class="pt--1 text-stroke label label-installs" style="position: absolute;" data-t="installs" data-t-value="{{ total_installs }}">{% raw %}.input {$value :number} .match $value zero {{No install}} one {{{$value :number} install}} * {{{$value :number} installs}}{% endraw %}</span>
    <span class="pt--1 text-stroke label label-forks" data-t="forks" data-t-value="{{ total_forks }}">{% raw %}.input {$value :number} .match $value zero {{No fork}} one {{{$value :number} fork}} * {{{$value :number} forks}} {% endraw %}</span>
    {% else %}
    <span class="pt--1 text-stroke label label-connections" data-t="connections" data-t-value="{{ total_connections }}">{% raw %}.input {$value :number} .match $value zero {{No connection}} one {{{$value :number} connection}} * {{{$value :number} connections}}{% endraw %}</span>
    <span class="pt--1 text-stroke label label-installs" style="position: absolute;" data-t="installs" data-t-value="{{ total_installs }}">{% raw %}.input {$value :number} .match $value zero {{No install}} one {{{$value :number} install}} * {{{$value :number} installs}}{% endraw %}</span>
    <span class="pt--1 text-stroke label label-forks" data-t="forks" data-t-value="{{ total_forks }}">{% raw %}.input {$value :number} .match $value zero {{No fork}} one {{{$value :number} fork}} * {{{$value :number} forks}} {% endraw %}</span>
    {% endif %}
  </div>
</div>
{% else %}
<div class="title_bar">
  <img class="image" src="https://usetrmnl.com/images/plugins/trmnl--render.svg" alt="TRMNL Logo">
  <span class="title">Public Recipe Stats</span>
  <span class="instance" data-t="connections" data-t-value="{{ total_connections }}">{% raw %}.input {$value :number} .match $value zero {{No connection}} one {{{$value :number} connection} * {{{$value :number} connections}}{% endraw %}</span>
</div>
{% endif %}
</div>

<style>
.truncate-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.screenshot-border {
  border: 1px solid #000;
}
.screen--1bit .-m-b--1, .screen--2bit .-m-b--1 {
  margin-bottom: -0.25rem;
}
.aspect--5\/3 {
  aspect-ratio: 5 / 3;
}
.screen--1bit .binarize, .screen--2bit .binarize {
  /* for when image-dither didn’t take effect in preview */
  filter: url(#binarize);
}
</style>
<script>
  {% if trmnl.plugin_settings.custom_fields_values.selection == "recipe_ids" %}
    (() => {
    const root = document.currentScript.closest(".view");
    const container = root.querySelector("[data-overflow-max-cols] .column");
    const children = Array.from(container.children);

    children.sort((a, b) => {
      const scoreA = parseInt(a.dataset.installs || 0) + parseInt(a.dataset.forks || 0);
      const scoreB = parseInt(b.dataset.installs || 0) + parseInt(b.dataset.forks || 0);
      return scoreB - scoreA;
    });
    
    children.forEach((child, idx) => {
      child.querySelector(".meta .index").innerText = idx + 1;
      container.appendChild(child)
    });
  })();
  {% endif %}
  (() => {
    const root = document.currentScript.closest(".view");
    const container = root.querySelector(".pbar-title");
    const installs = container.querySelector(".label-installs");
    const connections = container.querySelector(".label-connections");
    const forks = container.querySelector(".label-forks");
    const pbar = container.querySelector(".installs-progress-bar");

    const resizeObserver = new ResizeObserver((entries) => {
      // Get bounding rectangles relative to container
      const containerRect = container.getBoundingClientRect();
      const pbarRect = pbar.getBoundingClientRect();
      const installsRect = installs.getBoundingClientRect();
      const connectionsRect = connections.getBoundingClientRect();
      const forksRect = forks.getBoundingClientRect();
      
      // Calculate positions relative to container
      const pbarRightRelative = pbarRect.right - containerRect.left;
      const connectionsRightRelative = connectionsRect.right - containerRect.left + 20;
      const forksLeftRelative = forksRect.left - containerRect.left - 20;
      
      // Check which edge is closer to pbar right edge
      const distanceToForks = Math.abs(pbarRightRelative - forksLeftRelative);
      const distanceToConnections = Math.abs(pbarRightRelative - connectionsRightRelative);
      
      // Position installs based on the rules
      let positioned = false;
      
      // Rule: Try right = 10px left of pbar right edge
      if (!positioned) {
        const optionRight = containerRect.width - pbarRightRelative + 10;
        const optionLeft = containerRect.width - optionRight - installsRect.width;
        if (optionLeft > connectionsRightRelative && optionLeft + installsRect.width < forksLeftRelative) {
          installs.style.right = `${optionRight}px`;
          installs.style.left = 'auto';
          installs.dataset.rule = "Try right = 10px left of pbar right edge";
          positioned = true;
        }
      }
      
      // Rule: Try left = 10px right of pbar right edge
      if (!positioned) {
        const optionLeft = pbarRightRelative + 10;
        const optionRight = optionLeft + installsRect.width;
        if (optionRight < forksLeftRelative && optionLeft > connectionsRightRelative) {
          installs.style.left = `${optionLeft}px`;
          installs.style.right = 'auto';
          installs.dataset.rule = "Try left = 10px right of pbar right edge";
          positioned = true;
        }
      }
      
      // Rule: If pbar right edge closer to forks: right = forks left edge - 20px
      if (!positioned && distanceToForks <= distanceToConnections) {
        const optionRight = containerRect.width - forksLeftRelative;
        const optionLeft = containerRect.width - optionRight - installsRect.width;
        if (optionLeft > connectionsRightRelative) {
          installs.style.right = `${optionRight}px`;
          installs.style.left = 'auto';
          installs.dataset.rule = "If pbar right edge closer to forks: right = forks left edge - 20px";
          positioned = true;
        }
      }
      
      // Rule: If pbar right edge closer to connections: left = connections right edge + 20px
      if (!positioned && distanceToConnections < distanceToForks) {
        const optionLeft = connectionsRightRelative;
        const optionRight = optionLeft + installsRect.width;
        if (optionRight < forksLeftRelative) {
          installs.style.left = `${optionLeft}px`;
          installs.style.right = 'auto';
          installs.dataset.rule = " If pbar right edge closer to connections: left = connections right edge + 20px";
          positioned = true;
        }
      }
    });

    resizeObserver.observe(root);
    resizeObserver.observe(connections);
    resizeObserver.observe(forks);
    resizeObserver.observe(installs);
    
  })();
</script>

<script>
async function handleImageError(img) {
  try {
    const response = await fetch(img.src);
    const blob = await response.blob();
    const svgBlob = new Blob([await blob.text()], { type: img.dataset?.contentType || 'image/svg+xml' });
    const blobUrl = URL.createObjectURL(svgBlob);
    img.onerror = null; // Prevent infinite loop if blob URL also fails
    img.src = blobUrl;
  } catch (error) {
    console.error('Failed to load image:', error);
  }
}
</script>

<script type="module" data-t-script>
  import { applyPlaintext } from 'https://cdn.jsdelivr.net/gh/blueset/trmnl-tricks@2e95bbd620f0c5d0726e3dfbe4d765edb417ccf8/i18n.js';
  applyPlaintext();
</script>


{% endtemplate %}

{% liquid 
	case trmnl.plugin_settings.custom_fields_values.selection
	when "recipe_ids"
		assign json_data_str = "["
		if IDX_0.data
			assign j = IDX_0.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_1.data
			assign j = IDX_1.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_2.data
			assign j = IDX_2.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_3.data
			assign j = IDX_3.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_4.data
			assign j = IDX_4.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_5.data
			assign j = IDX_5.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_6.data
			assign j = IDX_6.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_7.data
			assign j = IDX_7.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_8.data
			assign j = IDX_8.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_9.data
			assign j = IDX_9.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_10.data
			assign j = IDX_10.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_11.data
			assign j = IDX_11.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_12.data
			assign j = IDX_12.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_13.data
			assign j = IDX_13.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_14.data
			assign j = IDX_14.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_15.data
			assign j = IDX_15.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_16.data
			assign j = IDX_16.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_17.data
			assign j = IDX_17.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_18.data
			assign j = IDX_18.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_19.data
			assign j = IDX_19.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		if IDX_20.data
			assign j = IDX_20.data | json
			assign json_data_str = json_data_str | append: j | append: ","
		endif
		assign json_data_end_index = json_data_str | size | minus: 1
		assign json_data_str = json_data_str | slice: 0, json_data_end_index | append: "]"
		assign json_data = json_data_str | parse_json
	else
		assign json_data = data
	endcase
%}