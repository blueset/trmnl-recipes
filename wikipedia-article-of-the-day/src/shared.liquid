<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">

<style>
  @import url("https://fontsapi.zeoseven.com/359/main/result.css");
  @import url("https://fontsapi.zeoseven.com/536/main/result.css");
  @import url("https://fontsapi.zeoseven.com/570/12px/result.css");
  
  @font-face {
    font-family: 'UnifontExMono';
    src: url('https://stgiga.github.io/UnifontEX/UnifontExMono.eot'); /* IE9 Compat Modes */
    src: url('https://stgiga.github.io/UnifontEX/UnifontExMono.eot?#iefix') format('embedded-opentype'), /* IE6-IE8 */
         url('https://stgiga.github.io/UnifontEX/UnifontExMono.woff') format('woff'), /* Pretty Modern Browsers */
         url('https://stgiga.github.io/UnifontEX/UnifontExMono.ttf')  format('truetype'), /* Safari, Android, iOS */
         url('https://stgiga.github.io/UnifontEX/UnifontExMono.woff2') format('woff2'), /* Super Modern Browsers */
         url('https://stgiga.github.io/UnifontEX/UnifontExMono.svg#UnifontExMono') format('svg'); /* Legacy iOS */
  }
  @font-face{
    font-family: "Hibiya24";
    src: url("https://togaras1.net/assets/font/KH-Dot-Hibiya-24.woff") format("woff");
  }
  @font-face {
      font-family: 'Unifont';
      src: url('https://konard.github.io/twittermatrix/unifont.woff') format('woff'), url('https://konard.github.io/twittermatrix/unifont.ttf') format('truetype');
  }
  @font-face {
      font-family: fusion-pixel-12px-proportional-zh_hans;
      src: url("https://fusion-pixel-font.takwolf.com/fusion-pixel-12px-proportional-zh_hans.otf.woff2");
  }
  @font-face {
      font-family: 'C16XCN';
      font-weight: bold;
      src: url('https://blueset.github.io/wikipedia-featured/fonts/c16xcnb.woff2') format('woff2'),
           url('https://blueset.github.io/wikipedia-featured/fonts/c16xcnb.ttf') format('truetype');
  }
  @font-face {
      font-family: 'C16XCN';
      font-weight: normal;
      src: url('https://blueset.github.io/wikipedia-featured/fonts/c16xcnr.woff2') format('woff2'),
           url('https://blueset.github.io/wikipedia-featured/fonts/c16xcnr.ttf') format('truetype');
  }
  @font-face {
    font-family: 'C24XCN';
    src: url('https://blueset.github.io/wikipedia-featured/fonts/c24xcn.woff2') format('woff2'),
         url('https://blueset.github.io/wikipedia-featured/fonts/c24xcn.ttf') format('truetype');
  }
  @font-face {
      font-family: 'JF-Dot-Shinonome16';
      font-weight: bold;
      src: url('https://blueset.github.io/wikipedia-featured/fonts/JF-Dot-Shinonome16B.woff2') format('woff2'),
           url('https://blueset.github.io/wikipedia-featured/fonts/JF-Dot-Shinonome16B.ttf') format('truetype');
  }
  @font-face {
      font-family: 'JF-Dot-Shinonome16';
      font-weight: normal;
      src: url('https://blueset.github.io/wikipedia-featured/fonts/JF-Dot-Shinonome16.woff2') format('woff2'),
           url('https://blueset.github.io/wikipedia-featured/fonts/JF-Dot-Shinonome16.ttf') format('truetype');
  }
  
  .trmnl .richtext .content p, .content p {
    line-height: 20px;
    word-break: normal;
  }

  .trmnl .screen--4bit {
    .wiki-richtext .title {
      &:lang(bn), &:lang(el), &:lang(en), &:lang(hu), &:lang(sv), &:lang(zh) {
        font-family: 'Linux Libertine','Georgia','Times','Source Serif 4',serif;
      }
      &:lang(de), &:lang(vi) {
        font-family: "Linux Libertine","Palatino Linotype","Georgia","Times",serif;
      }
      &:lang(sd) {
        font-family: "SSRead",Georgia,Arial,Calibri,Times,sans-serif;
      }
      &:lang(ur) {
        font-family: "Jameel Noori Nastaleeq","Mehr Nastaliq Web","Alvi Lahori Nastaleeq","Alvi Nastaleeq","Nafees Nastaleeq","Nafees Nastaleeq v1.01","Pak Nastaleeq","Urdu Emad Nastaleeq","PDMS_Jauhar","Urdu Typesetting",Nafees,IranNastaliq,Amiri,Georgia,"Times New Roman",Times,sans-serif;
      }
    }
  }
  
  .trmnl .screen--1bit, .trmnl .screen--2bit {
    .richtext .content:lang(ja), .content:lang(ja),
    .title_bar .title:lang(ja), .title_bar .title:lang(ja){
      font-family: "JF-Dot-Shinonome16", "DotGothic16", sans-serif;
      padding-top: 0;
      font-size: 16px;
    }
    .richtext .content:lang(zh), .content:lang(zh),
    .title_bar .title:lang(zh), .title_bar .title:lang(zh){
      font-family: "寒蝉点阵体 16px", "C16XCN", "Unifont", sans-serif;
      padding-top: 0;
      font-size: 16px;
    }
    .label.label--small:lang(ja), .label.label--small:lang(ja) {
      font-family: "UnifontExMono", sans-serif;
    }
    .label.label--small:lang(zh), .label.label--small:lang(zh) {
      /* font-family: "fusion-pixel-12px-proportional-zh_hans", sans-serif;
      font-size: 12px; */
      font-family: "寒蝉点阵体 16px", "C16XCN", "Unifont", sans-serif;
    }
    .title:lang(ja), .title:lang(ja) {
      font-family: "Hibiya24", sans-serif;
      font-size: 24px;
    }
    .title:lang(zh), .title:lang(zh) {
      font-family: "C24XCN", "Hibiya24", "NanoDyongChyangSong TCN 24", "Unifont", serif;
      font-size: 24px;
    }

    .description:lang(zh) {
      font-family: "Fusion Pixel 12px P latin", sans-serif;
      font-size: 12px;
    }
    
    b {
      text-decoration: underline dotted;
    }
  }
  .trmnl .screen--4bit .richtext .content b {
    font-weight: 800;
    font-variation-settings: "wght" 800;
  }
  .title_bar .title {
    width: 0;
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .title_bar .instance {
    flex-grow: 0;
  }

  .wiki-columns {
    height: 100%;
    align-items: center;
  }
  .wiki-column {
      justify-content: safe center;
      overflow: hidden;
  }
  
  .wiki-richtext .content {
      overflow: hidden;
  }
  
  .wiki-richtext, .wiki-itn, .wiki-dyn {
      max-height: 100%;
      overflow: hidden;
  }
  .wiki-richtext .content {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .wiki-itn a, .wiki-dyn a {
    text-decoration: none;
    color: inherit;
  }

  .wiki-itn figure, .wiki-dyn figure {
    display: none;
    max-width: 30%;
    .view--full &, .view--half_horizontal & {
      display: block;
    }
  }

  .wiki-dyn:lang(zh) b > a::after {
    content:  " (" attr(title) ")"
  }

  .wiki-ongoing:lang(en)::before {
    content: "Ongoing: ";
  }
  .wiki-recent-deaths:lang(en)::before {
    content: "Recent deaths: ";
  }
  .wiki-ongoing:lang(zh)::before {
    content: "正在发生：";
  }
  .wiki-recent-deaths:lang(zh)::before {
    content: "最近逝世：";
  }
</style>

{% liquid 
  assign language = trmnl.plugin_settings.custom_fields_values.language
  assign view = ""
  if language == "en"
    assign view = trmnl.plugin_settings.custom_fields_values.en_view
  elsif language == "zh"
    assign view = trmnl.plugin_settings.custom_fields_values.zh_view
  endif
%}

<div class="layout" lang="{{ language }}">
  {% if view == "dyn" %}
  <div class="flex flex--row gap wiki-dyn">
    <div class="flex flex--col gap" data-overflow="true">
      {% for fact in facts %}
      <div class="item richtext">
        <div class="meta"></div>
        <div class="content">
          <p>{{ fact.html }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
    {% if image.url %}<figure class="content"><img src="{{ image.url }}" alt="{{ image.alt }}" class="image image-dither" />{% if image.caption %}<figcaption class="description">{{ image.caption }}</figcaption>{% endif %}{% endif %}
  </div>
  {% elsif view == "itn" %}
  <div class="flex flex--row gap wiki-itn">
    <div class="flex flex--col gap" data-overflow="true">
      {% for headline in headlines %}
      <div class="item richtext">
        <div class="meta"></div>
        <div class="content">
          <p>{{ headline.html }}</p>
        </div>
      </div>
      {% endfor %}
      <div class="item">
        <div class="meta"></div>
        <div class="content">
          <span class="description wiki-ongoing">{% for og in ongoing %}{{ og.text }}{% unless forloop.last %} · {% endunless %}{% endfor %}</span>
        </div>
      </div>
      <div class="item">
        <div class="meta"></div>
        <div class="content">
          <span class="description wiki-recent-deaths">{% for rd in recentDeaths %}{{ rd.name }}{% unless forloop.last %} · {% endunless %}{% endfor %}</span>
        </div>
      </div>
    </div>
    {% if image.url %}<figure class="content"><img src="{{ image.url }}" alt="{{ image.alt }}" class="image image-dither" />{% if image.caption %}<figcaption class="description">{{ image.caption }}</figcaption>{% endif %}{% endif %}
  </div>
  {% else %}
  <div class="columns wiki-columns">
    <div class="column wiki-column">
      <div class="richtext richtext--center gap--medium wiki-richtext">
        <span class="title text--center" dir="auto">{{ title }}</span>
        {% if description %}<span class="label label--small text--center" dir="auto">{{ description }}</span>{% endif %}
        <div class="content" dir="auto">
          {{ extract_html }}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<div class="title_bar" lang="{{ language }}">
  <img class="image image-stroke" src="https://upload.wikimedia.org/wikipedia/commons/5/5a/Wikipedia%27s_W.svg">
  <span class="title">{{ trmnl.plugin_settings.instance_name }}</span>
  <span class="instance">{{ timestamp | default: "now" | date: trmnl.plugin_settings.custom_fields_values.date_format }}</span>
</div>

<script>
  (() => {
    const root = document.currentScript.closest(".view");
    const content = root.querySelector(".wiki-richtext .content");
    const p = root.querySelector(".wiki-richtext .content p");
    function measure(reset) {
      if (reset && content) {
        content.style.webkitLineClamp = "";
      }
      const height = content.getBoundingClientRect().height;
      const lineHeight = parseInt(getComputedStyle(p || content).lineHeight);
      const lines = Math.floor(height / lineHeight);
      console.log("clamp lines to", lines, height, lineHeight, content);
      content.style.webkitLineClamp = lines;
    }
    const resizeObserver = new ResizeObserver((entries) => {
      const reset = entries.filter(e => e.target.classList.contains('view') || e.target === root).length > 0;
      measure(reset);
    });
    resizeObserver.observe(root);
    resizeObserver.observe(p);
    document.fonts.ready.then(() => measure(true));
    document.fonts.addEventListener('loadingdone', () => measure(true));
    window.addEventListener('load', () => measure(true));
    window.addEventListener('resize', () => measure(true));
    window.addEventListener('orientationchange', () => measure(true));
    setTimeout(() => {
      measure(true)
      document.fonts.ready.then(() => {
        measure(true)
      });
    }, 2000);
  })();
</script>
