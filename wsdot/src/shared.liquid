{% template trafficTime %}
{% assign lastUpdated = trafficTime[0].updated | date: "%H:%M" %}
{% assign size = trafficTime | size %}
{% if size > 0 %}
<div class="layout--top layout">
  <div class="columns" data-overflow-max-cols="{{ cols | default: 3 }}">
    <div class="column">
      {% for item in trafficTime %}
        <div class="item">
          <div class="meta"></div>
          <div class="content">
            <span class="{{ titleClass | default: 'title title--small' }}" {{ titleAttr }}>{{ item.title }}</span>
            <span class="{{ originDestClass | default: 'description traffic-time-desc' }}">{{ item.origin }} →<br/>{{ item.destination }}</span>
            <div class="{{ timeBoxClass | default: 'flex flex--row gap--xsmall' }}">
              {% assign diff = item.currentTravelTime | minus: item.averageTravelTime %}
              <span class="{{ diffValueClass | default: 'value' }} {% if diff == 0 %}text--gray-55{% endif %}">
                {% if diff > 0 %}
                  +{{ diff }}<small class="{{ minClass | default: 'value--xsmall' }}"> min</small>
                {% elsif diff < 0 %}
                  {{ diff }}<small class="{{ minClass | default: 'value--xsmall' }}"> min</small>
                {% else %}
                  ±0<small class="{{ minClass | default: 'value--xsmall' }}"> min</small>
                {% endif %}
              </span>
              <div class="{{ avgCurClass | default: 'flex flex--col gap--none flex--left' }}">
                <span class="label label--small">avg. {{ item.averageTravelTime }}m</span>
                <span class="{{ curTimeClass | default: 'label label--small' }}">curr. {{ item.currentTravelTime }}m</span>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
<div class="layout">
  <span class="text--center title title--small" style="text-wrap : balance;">No traffic time found with names specified.</span>
</div>
{% endif %}

<div class="title_bar">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="image-stroke"><path fill="#000" d="M12 6.5a5.5 5.5 0 1 0-11 0a5.5 5.5 0 0 0 11 0M6.5 3a.5.5 0 0 1 .5.5V6h2a.5.5 0 0 1 0 1H6.5a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5m6.326 5q.172-.722.174-1.496a2.75 2.75 0 0 1 2.226 1.348l2.508 4.246l2.183.546A2.75 2.75 0 0 1 22 15.312V17a2.75 2.75 0 0 1-1.585 2.492a3.251 3.251 0 0 1-6.258.258H9.343a3.251 3.251 0 0 1-6.32-.61A2.75 2.75 0 0 1 2 17v-2.25a2.75 2.75 0 0 1 1.531-2.466c.89.458 1.9.716 2.969.716a6.48 6.48 0 0 0 4.5-1.81V12h4.934l-2-3.386A1.25 1.25 0 0 0 12.859 8zm1.212 10.25a3.25 3.25 0 0 1 6.274-.59A1.24 1.24 0 0 0 20.5 17v-1.688a1.25 1.25 0 0 0-.947-1.213l-2.397-.599H4.75c-.69 0-1.25.56-1.25 1.25v2.267a3.25 3.25 0 0 1 5.962 1.233zM6.25 17a1.75 1.75 0 1 0 0 3.5a1.75 1.75 0 0 0 0-3.5m9.25 1.75a1.75 1.75 0 1 0 3.5 0a1.75 1.75 0 0 0-3.5 0"/></svg>
  <span class="title">Traffic time</span>
  <span class="instance">Last updated: {{ lastUpdated }}</span>
</div>
{% endtemplate %}

{% template alerts %}
{% assign size = alerts | size %}
{% unless hideMap %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endunless %}
{% if size > 0 %}
<div class="layout {{ layoutClass }}">
  <div class="grid grid--cols-5 h--full">
    <div class="{{ alertsColClass | default: 'col--span-3 flex flex--col' }}" data-overflow="true">
      {% for item in alerts %}
        <div class="item">
          <span class="meta"><span class="index">{{ forloop.index | add: 1 }}</span></span>
          <div class="{{ alertContentClass | default: 'content gap--xsmall' }}">
            <div class="flex flex--row gap--xsmall">
              {% case item.severityLevel %}
              {% when "Highest" %}
              <svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20"><path fill="currentColor" d="M7.877 2.879a3 3 0 0 1 4.242 0l4.998 4.998a3 3 0 0 1 0 4.242l-4.998 4.998a3 3 0 0 1-4.242 0L2.879 12.12a3 3 0 0 1 0-4.242zm-.023 4.267a.5.5 0 1 0-.708.708L9.293 10l-2.147 2.146a.5.5 0 0 0 .708.708L10 10.707l2.146 2.147a.5.5 0 0 0 .708-.708L10.707 10l2.147-2.146a.5.5 0 0 0-.708-.708L10 9.293z"/></svg>
              {% when "High" %}
              <svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20"><path fill="currentColor" d="M10 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16M7.81 7.114a.5.5 0 0 0-.638.058l-.058.069a.5.5 0 0 0 .058.638L9.292 10l-2.12 2.121l-.058.07a.5.5 0 0 0 .058.637l.069.058a.5.5 0 0 0 .638-.058L10 10.708l2.121 2.12l.07.058a.5.5 0 0 0 .637-.058l.058-.069a.5.5 0 0 0-.058-.638L10.708 10l2.12-2.121l.058-.07a.5.5 0 0 0-.058-.637l-.069-.058a.5.5 0 0 0-.638.058L10 9.292l-2.121-2.12z"/></svg>
              {% when "Medium" %}
              <svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20"><path fill="currentColor" d="M9.562 3.262a.5.5 0 0 1 .88 0l6.5 12a.5.5 0 0 1-.44.739H3.5a.5.5 0 0 1-.44-.738zm1.758-.476c-.567-1.048-2.07-1.048-2.637 0l-6.502 12a1.5 1.5 0 0 0 1.318 2.215h13.003a1.5 1.5 0 0 0 1.319-2.215zM10.5 7.5a.5.5 0 0 0-1 0v4a.5.5 0 1 0 1 0zm.25 6.25a.75.75 0 1 1-1.5 0a.75.75 0 0 1 1.5 0"/></svg>
              {% when "Low" %}
              <svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20"><path fill="currentColor" d="M10.492 8.91A.5.5 0 0 0 9.5 9v4.502l.008.09a.5.5 0 0 0 .992-.09V9zm.307-2.16a.75.75 0 1 0-1.5 0a.75.75 0 0 0 1.5 0M18 10a8 8 0 1 0-16 0a8 8 0 0 0 16 0M3 10a7 7 0 1 1 14 0a7 7 0 0 1-14 0"/></svg>
              {% when "Lowest" %}
              <svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20"><path fill="currentColor" d="M11.369 16.867a.5.5 0 0 1 .193.98c-1.01.2-2.11.2-3.121 0a.5.5 0 1 1 .194-.98c.883.174 1.85.174 2.734 0M3.487 13.75a.5.5 0 0 1 .693.137a7 7 0 0 0 1.933 1.933a.5.5 0 0 1-.557.83a8 8 0 0 1-2.207-2.206a.5.5 0 0 1 .138-.694m12.336.137a.5.5 0 0 1 .83.557a8 8 0 0 1-2.206 2.207a.5.5 0 0 1-.557-.831a7 7 0 0 0 1.933-1.933m-3.176-6.241a.5.5 0 1 1 .707.707l-4 4a.5.5 0 0 1-.707 0l-2-2a.5.5 0 0 1 .629-.771l.078.064L9 11.293zm-9.905.398a.5.5 0 0 1 .393.588a7.2 7.2 0 0 0 0 2.734a.5.5 0 0 1-.981.193a8.2 8.2 0 0 1 0-3.121a.5.5 0 0 1 .588-.394m14.52 0a.5.5 0 0 1 .587.394c.2 1.01.2 2.11 0 3.121a.5.5 0 0 1-.98-.193a7.2 7.2 0 0 0 0-2.734a.5.5 0 0 1 .393-.588M5.556 3.347a.5.5 0 0 1 .557.831A7 7 0 0 0 4.18 6.111a.5.5 0 0 1-.83-.557a8 8 0 0 1 2.206-2.207m8.197.138a.5.5 0 0 1 .694-.138a8 8 0 0 1 2.207 2.207a.5.5 0 0 1-.831.557a7 7 0 0 0-1.933-1.933a.5.5 0 0 1-.137-.693M8.441 2.152a8.2 8.2 0 0 1 3.121 0a.5.5 0 0 1-.193.981a7.2 7.2 0 0 0-2.734 0a.5.5 0 0 1-.194-.981"/></svg>
              {% else %}
              <span class="px--1 label--outline label label--small">{{ item.severityLevel }}</span>
              {% endcase %}
              <span class="label label--alert-type">{{ item.alertType }}</span>
            </div>
            <div class="description" {{ descriptionAttr }}>{{ item.content }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
    {% unless hideMap %}
    <div class="{{ mapColClass | default: 'col--span-2 image image-dither' }}">
      <div class="w--full h--full"  id="map-container"></div>
    </div>
    {% endunless %}
  </div>
</div>
{% else %}
<div class="layout">
  <span class="text--center title title--small" style="text-wrap : balance;">No alerts found in the area. Have a safe trip!</span>
</div>
{% endif %}

<div class="title_bar">
  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" class="image-stroke"><path fill="#000" d="M14.374 2.334A.75.75 0 0 0 13 2.75v5.5a.75.75 0 0 0 1.5 0V5.227l1.313 1.969c.2.3.583.415.915.275l3.067-1.293l-1.23 2.767A.75.75 0 0 0 19.25 10h3.399l-1.475 1.77a.75.75 0 0 0 .012.974l2.411 2.756h-2.845a.75.75 0 1 0 0 1.5h4.498a.75.75 0 0 0 .564-1.244l-3.078-3.518l2.09-2.508a.75.75 0 0 0-.576-1.23h-3.846l1.531-3.445a.75.75 0 0 0-.976-.996l-4.242 1.789zM14.5 20a1 1 0 1 0 0-2a1 1 0 0 0 0 2M7 19a1 1 0 1 1-2 0a1 1 0 0 1 2 0m1.75 0a.75.75 0 1 0 0 1.5h3a.75.75 0 0 0 0-1.5zm-6-3.5h.418A2.75 2.75 0 0 0 2 17.75v4.5q0 .064.01.125A1 1 0 0 0 2 22.5v1.75c0 .967.784 1.75 1.75 1.75h1.5A1.75 1.75 0 0 0 7 24.25V23h6.5v1.25c0 .967.784 1.75 1.75 1.75h1.5a1.75 1.75 0 0 0 1.75-1.75v-6.5c0-.93-.462-1.752-1.169-2.25h.419a.75.75 0 0 0 0-1.5H16.5a1 1 0 0 0-.144.014l-.32-1.756A2.75 2.75 0 0 0 13.331 10H7.169a2.75 2.75 0 0 0-2.706 2.258L4.147 14H2.75a.75.75 0 1 0 0 1.5m.75 2.25c0-.69.56-1.25 1.25-1.25h11c.69 0 1.25.56 1.25 1.25v3.75H3.5zm11.06-5.224L15.01 15H5.49l.45-2.474A1.25 1.25 0 0 1 7.17 11.5h6.16a1.25 1.25 0 0 1 1.23 1.026M15 24.25V23h2v1.25a.25.25 0 0 1-.25.25h-1.5a.25.25 0 0 1-.25-.25M5.5 23v1.25a.25.25 0 0 1-.25.25h-1.5a.25.25 0 0 1-.25-.25V23z"/></svg>
  <span class="title">Traffic Alerts</span>
  <span class="instance">WSDOT</span>
</div>

{% unless hideMap %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-providers@latest/leaflet-providers.js"></script>
<script>
  const data = {{ alerts | json }};
  const mapContainer = document.getElementById('map-container');
  // 1. Array of coordinates [lat, lng, label]
  const points = data.map((item, idx) => [item.coordinates.latitude, item.coordinates.longitude, idx + 1, item.severityLevel]);

  // 2. Initialize map (set view is temporary, fitBounds will override)
  const map = L.map('map-container', {zoomControl: false}).setView([0, 0], 2);

  // 3. Add a tile layer with NO labels
  // Other option: 'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png'
  // L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
  //     attribution: '© OpenStreetMap contributors © CARTO'
  // }).addTo(map);
  L.tileLayer.provider('OpenStreetMap.CAT').addTo(map);
  
  
  // 4. Create a group to track the bounds
  const markers = [];
  
  points.forEach(p => {
      // Create custom HTML icon
      const customIcon = L.divIcon({
          className: 'custom-div-icon', // Clear default styling
        {% if showIcon %}
          html: 
            p[3] === "Highest" ?
            `<svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20" stroke="#fff" stroke-width="4" paint-order="stroke fill"><path fill="currentColor" d="M7.877 2.879a3 3 0 0 1 4.242 0l4.998 4.998a3 3 0 0 1 0 4.242l-4.998 4.998a3 3 0 0 1-4.242 0L2.879 12.12a3 3 0 0 1 0-4.242zm-.023 4.267a.5.5 0 1 0-.708.708L9.293 10l-2.147 2.146a.5.5 0 0 0 .708.708L10 10.707l2.146 2.147a.5.5 0 0 0 .708-.708L10.707 10l2.147-2.146a.5.5 0 0 0-.708-.708L10 9.293z"/></svg>`
            : p[3] === "High" ?
            `<svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20" stroke="#fff" stroke-width="4" paint-order="stroke fill"><path fill="currentColor" d="M10 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16M7.81 7.114a.5.5 0 0 0-.638.058l-.058.069a.5.5 0 0 0 .058.638L9.292 10l-2.12 2.121l-.058.07a.5.5 0 0 0 .058.637l.069.058a.5.5 0 0 0 .638-.058L10 10.708l2.121 2.12l.07.058a.5.5 0 0 0 .637-.058l.058-.069a.5.5 0 0 0-.058-.638L10.708 10l2.12-2.121l.058-.07a.5.5 0 0 0-.058-.637l-.069-.058a.5.5 0 0 0-.638.058L10 9.292l-2.121-2.12z"/></svg>`
            : p[3] === "Medium" ?
            `<svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20" stroke="#fff" stroke-width="4" paint-order="stroke fill"><path fill="currentColor" d="M9.562 3.262a.5.5 0 0 1 .88 0l6.5 12a.5.5 0 0 1-.44.739H3.5a.5.5 0 0 1-.44-.738zm1.758-.476c-.567-1.048-2.07-1.048-2.637 0l-6.502 12a1.5 1.5 0 0 0 1.318 2.215h13.003a1.5 1.5 0 0 0 1.319-2.215zM10.5 7.5a.5.5 0 0 0-1 0v4a.5.5 0 1 0 1 0zm.25 6.25a.75.75 0 1 1-1.5 0a.75.75 0 0 1 1.5 0"/></svg>`
            : p[3] === "Low" ?
            `<svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20" stroke="#fff" stroke-width="4" paint-order="stroke fill"><path fill="currentColor" d="M10.492 8.91A.5.5 0 0 0 9.5 9v4.502l.008.09a.5.5 0 0 0 .992-.09V9zm.307-2.16a.75.75 0 1 0-1.5 0a.75.75 0 0 0 1.5 0M18 10a8 8 0 1 0-16 0a8 8 0 0 0 16 0M3 10a7 7 0 1 1 14 0a7 7 0 0 1-14 0"/></svg>`
            : p[3] === "Lowest" ?
            `<svg xmlns="http://www.w3.org/2000/svg" class="image image-dither" width="20" height="20" viewBox="0 0 20 20" stroke="#fff" stroke-width="4" paint-order="stroke fill"><path fill="currentColor" d="M11.369 16.867a.5.5 0 0 1 .193.98c-1.01.2-2.11.2-3.121 0a.5.5 0 1 1 .194-.98c.883.174 1.85.174 2.734 0M3.487 13.75a.5.5 0 0 1 .693.137a7 7 0 0 0 1.933 1.933a.5.5 0 0 1-.557.83a8 8 0 0 1-2.207-2.206a.5.5 0 0 1 .138-.694m12.336.137a.5.5 0 0 1 .83.557a8 8 0 0 1-2.206 2.207a.5.5 0 0 1-.557-.831a7 7 0 0 0 1.933-1.933m-3.176-6.241a.5.5 0 1 1 .707.707l-4 4a.5.5 0 0 1-.707 0l-2-2a.5.5 0 0 1 .629-.771l.078.064L9 11.293zm-9.905.398a.5.5 0 0 1 .393.588a7.2 7.2 0 0 0 0 2.734a.5.5 0 0 1-.981.193a8.2 8.2 0 0 1 0-3.121a.5.5 0 0 1 .588-.394m14.52 0a.5.5 0 0 1 .587.394c.2 1.01.2 2.11 0 3.121a.5.5 0 0 1-.98-.193a7.2 7.2 0 0 0 0-2.734a.5.5 0 0 1 .393-.588M5.556 3.347a.5.5 0 0 1 .557.831A7 7 0 0 0 4.18 6.111a.5.5 0 0 1-.83-.557a8 8 0 0 1 2.206-2.207m8.197.138a.5.5 0 0 1 .694-.138a8 8 0 0 1 2.207 2.207a.5.5 0 0 1-.831.557a7 7 0 0 0-1.933-1.933a.5.5 0 0 1-.137-.693M8.441 2.152a8.2 8.2 0 0 1 3.121 0a.5.5 0 0 1-.193.981a7.2 7.2 0 0 0-2.734 0a.5.5 0 0 1-.194-.981"/></svg>`
            : `<div class="flex flex--center-x flex--center-y bg--white rounded--full w--6 h--6 label map-marker" style="border : 1px solid #000;"><span>${p[2]}</span></div>`,
        {% else %}
          html: `<div class="flex flex--center-x flex--center-y bg--white rounded--full w--6 h--6 label map-marker" style="border : 2px solid #000;"><span>${p[2]}</span></div>`,
        {% endif %}
          iconSize: [24, 24], // Size of the div
          iconAnchor: [12, 12] // Point where it "touches" the coordinate
      });

      const marker = L.marker([p[0], p[1]], { icon: customIcon }).addTo(map);
      markers.push([p[0], p[1]]);
  });

  // 5. Auto fit zoom and center based on markers
  if (markers.length > 0) {
      const bounds = L.latLngBounds(markers);
      map.fitBounds(bounds, { padding: [40, 40] });
  }

  // 6. Handle container resizing automatically
  window.addEventListener('resize', () => {
      map.invalidateSize();
    
      if (markers.length > 0) {
          const bounds = L.latLngBounds(markers);
          map.fitBounds(bounds, { padding: [40, 40] });
      }
  });
  const resizeObserver = new ResizeObserver(() => {
      map.invalidateSize();
    
      if (markers.length > 0) {
          const bounds = L.latLngBounds(markers);
          map.fitBounds(bounds, { padding: [40, 40] });
      }
  });
  resizeObserver.observe(mapContainer);
</script>
{% endunless %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Jersey+10&family=Tiny5&display=swap');
  .screen--1bit, .screen--2bit {
    .map-marker span, .label--alert-type {
      translate : 0 2px;
    }
  }
  .leaflet-control-attribution {
    font-size : 8px;
    line-height : 1;
    text-align : right;
    font-family : "Tiny5", sans-serif;
    white-space : pre;
    background-color : white !important;
  }
</style>
{% endtemplate %}

{% template cameras %}
{% assign size = cameras | size %}
{% if size > 0 %}
<div class="layout {{ layoutClass }}">
  <div class="columns camera-columns {% if cols == 1 or size == 1 %}h--full w--full{% endif %}"
    {% liquid 
      unless cols
        assign noCols = true 
      else
        assign noCols = false
      endunless
      assign showMaxCols = false
      if size > 1
        assign showMaxCols = true
      endif
      if showMaxCols
        if noCols == false and cols == 1
          assign showMaxCols = false
        endif
      endif
    %}
    {% if showMaxCols %}
    data-overflow-max-cols="{% if cols %}{{ cols }}{% else %}3{% endif %}"
    {% endif %}
  >
    <div class="column {% if cols == 1 or size == 1 %}h--full w--full{% endif %}">
      {% for item in cameras %}
        <div class="item {% if cols == 1 or size == 1 %}h--full w--full{% endif %}">
          <div class="gap--xsmall content">
            <div class="{{ cameraTitleClass | default: 'mb-2' }}" style="text-wrap: balance; {{ cameraTitleStyle }}">
              <span class="{{ cameraNameClass | default: 'title title--small' }}">{{ item.name }}</span>
              <span class="{{ cameraFolderClass | default: 'label label--small label--outline' }}">{{ item.folder }}</span>
            </div>
            <img class="camera-image image image-dither w--full {% if cols == 1 or size == 1 %}{% else %}aspect--16/9{% endif %}" src="{{ item.url }}" alt="Traffic Camera Image">
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% else %}
<div class="layout">
  <span class="text--center title title--small" style="text-wrap: balance;">No traffic camera found with names specified.</span>
</div>
{% endif %}

{% unless hideTitleBar %}
<div class="title_bar">
  <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" class="image-stroke"><path fill="#000" d="M17.5 16.5a3.5 3.5 0 1 1-7 0a3.5 3.5 0 0 1 7 0m-10 0a6.5 6.5 0 1 1 13 0a6.5 6.5 0 0 1-13 0m6.5-5a5 5 0 1 0 0 10a5 5 0 0 0 0-10M3.75 3A1.75 1.75 0 0 0 2 4.75v1.5c0 .698.409 1.3 1 1.582V15c0 6.075 4.925 11 11 11s11-4.925 11-11V7.832c.591-.281 1-.884 1-1.582v-1.5A1.75 1.75 0 0 0 24.25 3zM23.5 8v7a9.5 9.5 0 0 1-19 0V8zm.75-1.5H3.75a.25.25 0 0 1-.25-.25v-1.5a.25.25 0 0 1 .25-.25h20.5a.25.25 0 0 1 .25.25v1.5a.25.25 0 0 1-.25.25"/></svg>
  <span class="title">Traffic Cameras</span>
  <span class="instance">WSDOT</span>
</div>
{% endunless %}

<style>
  .camera-columns .column {
    align-self : stretch;
    justify-content : space-between;
  }
  .layout {
    container-type: size;
    .camera-image {
      max-height : calc(100cqh - var(--label-small-font-size) * 1.2 - var(--gap-xsmall));
    }
  }
</style>
{% endtemplate %}

{% assign view = trmnl.plugin_settings.custom_fields_values.view %}